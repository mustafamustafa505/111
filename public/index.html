<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>منصة تعدين — BARON MINING</title>
  <style>
    :root{--accent:#1e88e5;--bg:#0b1020;--card:#0f1724;--glass:rgba(255,255,255,0.03)}
    html,body{height:100%;margin:0;font-family:Tahoma,Arial;background:linear-gradient(90deg,#071226, #0b1020 40%, #071226);color:#e6eef6}
    header{display:flex;justify-content:space-between;align-items:center;padding:18px 40px}
    .logo{font-weight:800}
    .panorama-wrap{position:relative;height:420px;border-radius:12px;overflow:hidden;margin:20px;}
    #canvasPanorama{width:100%;height:100%;display:block}
    .overlay{position:absolute;inset:18px;pointer-events:none}
    .panorama-ui{position:absolute;bottom:18px;left:18px;pointer-events:auto}
    .panorama-ui .btn{padding:10px 14px;border-radius:10px;background:var(--accent);color:white;text-decoration:none;cursor:pointer;border:none}
    .plans{display:flex;gap:16px;padding:20px;overflow:auto}
    .plan{min-width:220px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:12px;padding:16px;box-shadow:0 8px 20px rgba(0,0,0,0.6);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,0.04)}
    .price{font-size:22px;font-weight:700;margin-top:8px}
    .muted{color:#9fb0c9;font-size:13px}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.65)}
    .modal .card{width:420px;padding:18px;background:#081025;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
  </style>
</head>
<body>
  <header>
    <div class="logo">BARON MINING</div>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="walletInput" placeholder="رابط محفظة للإيداع" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit;width:260px">
      <button class="btn" id="saveWallet">حفظ</button>
    </div>
  </header>

  <main style="padding:20px;max-width:1200px;margin:auto">
    <section class="panorama-wrap">
      <canvas id="canvasPanorama"></canvas>
      <div class="overlay">
        <div class="panorama-ui">
          <button class="btn" id="withdrawBtn">سحب الأرباح</button>
        </div>
      </div>
    </section>

    <section style="margin-top:18px">
      <h2>خطط الاشتراك</h2>
      <div class="plans" id="plansContainer"></div>
    </section>
  </main>

  <div class="modal" id="withdrawModal">
    <div class="card">
      <h3>طلب سحب الأرباح</h3>
      <div class="muted">أدخل عنوان محفظتك وقيمة السحب. سيُطلب دفع 2$ كرسوم لإتمام السحب.</div>
      <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px">
        <input id="withdrawAddr" placeholder="عنوان المحفظة" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06)">
        <input id="withdrawAmount" placeholder="المبلغ (USD)" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06)">
        <label class="muted"><input type="checkbox" id="agreeFee"> أوافق على خصم رسوم 2$ لإتمام السحب</label>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
          <button class="btn" id="confirmWithdraw">تأكيد السحب</button>
          <button id="cancelWithdraw" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06)">إلغاء</button>
        </div>
        <div id="withdrawMsg" class="muted" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- three.js CDN -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>

  <script>
    // خطط افتراضية (أسعار بالدولار - تُستخدم لإنشاء جلسة دفع)
    const plans = [
      {name:'تجربة مجانية (3 أيام)', key:'free', price:0, trialDays:3},
      {name:'خطة 10 دولار / شهر', key:'p10', price:10},
      {name:'خطة 25 دولار / شهر', key:'p25', price:25},
      {name:'خطة 50 دولار / شهر', key:'p50', price:50},
      {name:'خطة 100 دولار / شهر', key:'p100', price:100},
      {name:'خطة 200 دولار / شهر', key:'p200', price:200}
    ];

    // إنشاء بطاقات الخطط
    const plansContainer = document.getElementById('plansContainer');
    function renderPlans(){
      plansContainer.innerHTML='';
      plans.forEach(p=>{
        const el = document.createElement('div'); el.className='plan';
        el.innerHTML = `<h3>${p.name}</h3><div class="price">${p.price === 0 ? 'مجاناً' : '$'+p.price}</div><div class="muted">${p.trialDays? 'تجربة لمدة '+p.trialDays+' أيام' : 'اشتراك شهري'} </div><div style="margin-top:12px"><button class="btn" data-key="${p.key}">${p.price===0? 'تفعيل التجربة' : 'اشترك الآن'}</button></div>`;
        plansContainer.appendChild(el);
      });
    }
    renderPlans();

    // حفظ رابط المحفظة محلياً
    document.getElementById('saveWallet').addEventListener('click', ()=>{
      const val = document.getElementById('walletInput').value.trim();
      if(!val) return alert('أدخل رابط محفظة صالح');
      localStorage.setItem('depositWallet', val);
      alert('تم حفظ رابط المحفظتك محلياً');
    });

    // عند الضغط على اشترك -> اختر مزود الدفع ثم اطلب من السيرفر إنشاء جلسة دفع
    plansContainer.addEventListener('click', async (e)=>{
      if(e.target.tagName !== 'BUTTON') return;
      const key = e.target.dataset.key;
      // اختر المزود (بسيط: عرض prompt) — يمكن تغييره إلى UI أنيق لاحقاً
      const provider = prompt('اختر مزود الدفع: اكتب "stripe" أو "coinpayments"', 'stripe');
      if(!provider) return;
      const res = await fetch('/api/subscribe', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify({plan:key, provider: provider.trim().toLowerCase(), wallet: localStorage.getItem('depositWallet') || null})
      });
      const j = await res.json();
      if(j.url) {
        // توجيه المستخدم لصفحة الدفع
        window.location.href = j.url;
      } else {
        alert(j.message || 'حدث خطأ، تحقق من الخادم');
      }
    });

    // سحب
    const withdrawModal = document.getElementById('withdrawModal');
    document.getElementById('withdrawBtn').addEventListener('click', ()=> withdrawModal.style.display='flex');
    document.getElementById('cancelWithdraw').addEventListener('click', ()=> withdrawModal.style.display='none');
    document.getElementById('confirmWithdraw').addEventListener('click', async ()=>{
      const addr = document.getElementById('withdrawAddr').value.trim();
      const amt = document.getElementById('withdrawAmount').value.trim();
      const agree = document.getElementById('agreeFee').checked;
      const msg = document.getElementById('withdrawMsg'); msg.textContent = '';
      if(!addr || !amt) { msg.textContent = 'أدخل عنوان ومبلغ السحب'; return }
      if(!agree){ msg.textContent = 'يجب الموافقة على رسوم 2$ لإتمام السحب'; return }
      const res = await fetch('/api/withdraw',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({address:addr,amount:amt})});
      const j = await res.json();
      msg.textContent = j.message || 'تم إرسال طلب السحب';
    });

    // تحميل محفظة محفوظة
    document.addEventListener('DOMContentLoaded', ()=>{
      const w = localStorage.getItem('depositWallet'); if(w) document.getElementById('walletInput').value = w;
    });

    // ---------------------------
    // three.js panorama (خلفية)
    // ---------------------------
    const canvas = document.getElementById('canvasPanorama');
    const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(70, 2, 0.1, 1000);
    camera.position.set(0,0,0.1);

    const geometry = new THREE.SphereGeometry(500, 60, 40);
    geometry.scale(-1, 1, 1); // انعكاس للخلفية الداخلية

    const textureLoader = new THREE.TextureLoader();
    const panoUrl = '/assets/panorama.jpg'; // ضع صورة اٍيكوارنجولار هنا
    const material = new THREE.MeshBasicMaterial({map: textureLoader.load(panoUrl)});
    const mesh = new THREE.Mesh(geometry, material);
    scene.add(mesh);

    // جزيئات بسيطة
    const particlesGeo = new THREE.BufferGeometry();
    const count = 400;
    const positions = new Float32Array(count * 3);
    for(let i=0;i<count;i++){
      positions[i*3+0] = (Math.random()-0.5)*200;
      positions[i*3+1] = (Math.random()-0.5)*200;
      positions[i*3+2] = (Math.random()-0.5)*200;
    }
    particlesGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    const particlesMat = new THREE.PointsMaterial({size:1});
    const particles = new THREE.Points(particlesGeo, particlesMat);
    scene.add(particles);

    function resizeRendererToDisplaySize(renderer) {
      const canvas = renderer.domElement;
      const width = canvas.clientWidth;
      const height = canvas.clientHeight;
      const needResize = canvas.width !== width || canvas.height !== height;
      if (needResize) {
        renderer.setSize(width, height, false);
      }
      return needResize;
    }

    function animate(time) {
      time *= 0.001;
      resizeRendererToDisplaySize(renderer);
      const canvas = renderer.domElement;
      camera.aspect = canvas.clientWidth / canvas.clientHeight;
      camera.updateProjectionMatrix();

      mesh.rotation.y += 0.0006;
      particles.rotation.y += 0.0002;

      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);
  </script>
</body>
</html>